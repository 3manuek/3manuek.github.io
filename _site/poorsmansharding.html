

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>[Data on Weed] Poor's man sharding technique.</title>
    <meta name="description" content="No tenes un peso para el sharding?.">
    <meta name="author" content="Emanuel Calvo">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/css/1.4.0/bootstrap.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="/">emanuelHub</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
      	
      	<li><a href="/archive">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/refund_policy">Refund Policy</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/resume">Resume</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">Tags</a></li>
      	
      
    
  
    
  
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        

<div class="page-header">
  <h1>[Data on Weed] Poor's man sharding technique. <small></small></h1>
</div>

<div class="row">
  <div class="span10">
    <h2 id="if-you-are-sober-stop">If you are sober, STOP</h2>

<p>Data on Weed is a series of posts about data technologies with a twist. The twist is that you would never implement this in production
if you are sober or, if you really <em>fuching</em> know what you are doing.</p>

<h2 id="concept">Concept</h2>

<p>The <em>Poor’s man sharding technique</em> is nothing more than a combination of two existing features (inheritance and foreign data wrappers)
and one extension (<code class="highlighter-rouge">postgres_fdw</code>).</p>

<p>It consists in a <code class="highlighter-rouge">proxy</code> database and <code class="highlighter-rouge">shard</code> or <code class="highlighter-rouge">data</code> databases. Gues what. Yeah, <code class="highlighter-rouge">proxy</code> database holds the entry points and the <code class="highlighter-rouge">shard</code>
databases the data itself.</p>

<h2 id="warning">Warning</h2>

<p>This is a POC, which I will suggest you think very well if you decide go into this way. It is mostly for didactic purposes or if you
want to drain your brain out of your ears. Still preferable this way other than space bugs.</p>

<h2 id="how-this-works">How this “works”</h2>

<p>You can have more than one <code class="highlighter-rouge">proxy</code> database, as it does not persist the data. The <code class="highlighter-rouge">proxy</code> database
can be placed in a stand alone instance or on each server. Or anywhere. It does not matter. This
is good as your entry points are not SPOF.</p>

<p>The concept is very simple, proxy database holds the server definitions and user mappings, along 
with the entry point (table main,without data) and the inherited foreign data wrappers (which do not store data).
This leaves the proxy database with <em>metadata</em> only. Most importantly, it stores the partition 
function and the trigger defition.</p>

<p>When an INSERT falls in, trigger executes the function and split the write to the inherited tables
according to the key. This is a fake, as the table is a foreign table which points to a remote database.</p>

<p>The real tables will be on each <code class="highlighter-rouge">shardXX</code> database, the location is up to the engineer.</p>

<h2 id="no-magic-at-all">No magic at all</h2>

<p>As you expect, life sucks and sometimes one does not have time to dig into every crazy idea that prompts.
Special mention over those that come under doubtely states of consciousness.</p>

<p>For HA, SERVERs can point to slaves, but beware of this as you must need to change the
FOREIGN TABLE definition and promote them, otherwise <em>writes won’t work and reads will be stale</em>.</p>

<p>This technique is very simplistic, and it lacks of a lot of features provided for sharding tools.</p>

<p>Postgres 9.6 has a nice set of improvements on FDWs, specially related with condition pushdowns.
Being said, this kind of things will definitively a PITA under previous versions.</p>

<h2 id="proxy-database">proxy database</h2>

<p>I’m going to create two shards, because it’s hard to code being stoned. Actually I’m just lazy,
but my friend Elrich Bachman told me that if it doesn’t come in pairs, one is artificial.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE EXTENSION postgres_fdw;
</code></pre>
</div>

<p>These definitions are thw ones you’ll need to extend your shard:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE SERVER shard1_main FOREIGN DATA WRAPPER postgres_fdw
  OPTIONS(host '127.0.0.1',port '5434',dbname 'shard1');
CREATE SERVER shard2_main FOREIGN DATA WRAPPER postgres_fdw
  OPTIONS(host '127.0.0.1',port '5435',dbname 'shard2');

CREATE USER MAPPING FOR postgres SERVER shard1_main OPTIONS(user 'postgres');
CREATE USER MAPPING FOR postgres SERVER shard2_main OPTIONS(user 'postgres');
</code></pre>
</div>

<p>Create the tables, function and trigger. Obviously, you will need to create foreign tables as shards
you are planning to have:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE TABLE main (shardKey char(2), key bigint, avalue text);
CREATE FOREIGN TABLE main_shard01 (CHECK (shardKey = '01'))INHERITS (main) SERVER shard1_main;
CREATE FOREIGN TABLE main_shard02 (CHECK (shardKey = '02'))INHERITS (main) SERVER shard2_main;

CREATE OR REPLACE FUNCTION f_main_part() RETURNS TRIGGER AS
$FMAINPART$
DECLARE
            partition_name text;
BEGIN
            partition_name := 'main_shard' || NEW.shardKey;
            EXECUTE  'INSERT INTO ' ||  quote_ident(partition_name) ||  ' SELECT ($1).*' USING NEW ;
            RETURN NULL;
END;
$FMAINPART$ LANGUAGE plpgsql;

CREATE TRIGGER t_main BEFORE INSERT ON main FOR EACH ROW EXECUTE PROCEDURE f_main_part();
</code></pre>
</div>

<h2 id="shards">shards</h2>

<p>On shards is easier:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CREATE TABLE main_shard01(shardKey char(2), key bigint, avalue text, CHECK(shardKey='01'));
CREATE INDEX ON main_shard01(key);
</code></pre>
</div>

<h2 id="test">TEST</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>INSERT INTO main VALUES ('01',1,'trololol'),('01',2,random()::text),('02',2,random()::text);
</code></pre>
</div>

<h2 id="grab-them-from-the-hidden-columns"><em>Grab them from the hidden columns</em></h2>

<p>The tableoid is the shard one, not the proxy foreign definition, this is important.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>proxy=# select tableoid,* from main;
 tableoid | shardkey | key |      avalue       
----------+----------+-----+-------------------
    16422 | 01       |   1 | trololol
    16422 | 01       |   2 | 0.544912547804415
    16426 | 02       |   2 | 0.459446560591459
(3 rows)
</code></pre>
</div>


    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2016/11/26/shard-buffer-pool-with-proxysql" title="Shard Buffer Pool With Proxysql">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/postgres10logrepypart" title="Highlighting Postgres 10 new features: Logical Replication and Partitioning.">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>31 January 2017</span></div>

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/tags.html#PostgreSQL-ref">PostgreSQL <span>8</span></a></li>
     
    	<li><a href="/tags.html#Sharding-ref">Sharding <span>2</span></a></li>
     
    	<li><a href="/tags.html#cosasAtadasConAlambre-ref">cosasAtadasConAlambre <span>1</span></a></li>
    
  



    </ul>
    
  </div>
</div>


      </div>

      <footer>
        <p>&copy; Emanuel Calvo 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    



  </body>
</html>

