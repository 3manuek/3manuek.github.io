

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>How you can start MySQL Slow query analysis.</title>
    <meta name="description" content="Tools and resources.">
    <meta name="author" content="Emanuel Calvo">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/css/1.4.0/bootstrap.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="/">emanuelHub</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
      	
      	<li><a href="/archive">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/refund_policy">Refund Policy</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/resume">Resume</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags">Tags</a></li>
      	
      
    
  
    
  
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        

<div class="page-header">
  <h1>How you can start MySQL Slow query analysis. <small></small></h1>
</div>

<div class="row">
  <div class="span10">
    <h2 id="objective-of-the-article">Objective of the article</h2>

<p>This is not intended to be the ultimate guide for query analysis, it is just a simple starting guide for people that want to do so.
If you want to start from something, I strongly recommend you to start with <a href="https://www.amazon.es/Effective-MySQL-Optimizing-Statements-Oracle/dp/0071782796">Effective MySQL: optimizing SQL Statements by Ronald Bradford</a>.</p>

<p>Query Analysis is pretty much valuated for consultants, as a good query analysis
and query rewriting can <em>save money</em>. I saw customers buying new hardware just because <em>the MySQL was too slow</em>.</p>

<p>And -the most important- is not only about performance. A good query profiling can be a good
diagnostic of the entire software and data architecture. Sometimes, RDBMS are used for stuff
that are not the best fit for or, even NoSQLs were used when MySQL/Postgres can be a better fit.</p>

<p>Also, this article is not focus on SQL tricks or neither how to understand MySQL
explain, which I assume you already have some knowledge to continue the reading. A
very nice library to enjoy can be found at <a href="http://use-the-index-luke.com/">Use the index, Luke!</a>.</p>

<h2 id="the-approach">The approach</h2>

<p>First of all you need to know what the customer is literally doing in the server,
which information and type of server they have online. This may be something pretty
much <em>obvious</em>, but believe me, it is not trivial to repeat this.</p>

<p>A server could be part of a sharded cluster, a report server, a BI server, a web
<em>OLTP</em> server, test server, and so on. Market impose those infinite combinations,
however there are a few rules for good practice when writing queries. And those
good practices will depend on the RDBMS you are working on (in this particular case,
  we will focus on MySQL).</p>

<p>Now, you know what you need to get and how to start the analysis. Beyond query complexity,
sometimes you need to know which solution can be applied or not when you rewrite the query or provide suggestions.</p>

<p>Generally, queries can be slow due to:</p>

<ul>
  <li>Missing indexes</li>
  <li>Bad cardinality and not useful filters</li>
  <li>Inner joins with outer order using different keys</li>
  <li>File sorting</li>
  <li>Bad writing queries (large subqueries, large IN clauses, non targeted bugs, i.e.)</li>
</ul>

<p>Check the latest <a href="https://bugs.mysql.com/search.php?cmd=display&amp;status=Active&amp;severity=-5&amp;search_for=query&amp;os=0&amp;bug_age=0&amp;order_by=bug_type&amp;direction=ASC&amp;limit=10&amp;mine=0&amp;reorder_by=bug_type">bugs reported</a>.</p>

<h2 id="how-much-do-you-need-to-collect">How much do you need to collect?</h2>

<p>For a query analysis you want to collect <em>as much as you can</em>:</p>

<ul>
  <li>general query log, or</li>
  <li><code class="highlighter-rouge">long_query_time</code> = 0 or,</li>
  <li>tcpdump</li>
</ul>

<p>Using others will lead to non-complete profiling when processing. However, there are cases where is not possible to have the <code class="highlighter-rouge">long_query_time = 0</code> due to the high amount of TPS (<em>Transactions Per Second</em>). You can set it to <code class="highlighter-rouge">0.5</code> or higher. The closer to 0, the better.</p>

<p>You will collect the whole set of queries. You are not hunting <em>slow queries</em> but also <em>very frequent queries</em>. I did have cases where the issue was not regarding any slow query, but an application bug doing 2x the same query. Also you will be probably hunting buggy queries, with unnecessary large result sets, suspicious orders, bad FTS usage, slow procedures, etc.</p>

<p>Generally, when analyzing BI or reporting servers, it is accepted to have a large <code class="highlighter-rouge">long_query_time</code>, as you will probably focusing on slow queries.</p>

<h3 id="percona-enhancements-to-be-aware-of">Percona enhancements to be aware of</h3>

<p><a href="https://www.percona.com/doc/percona-server/5.7/diagnostics/slow_extended.html">Slow log extended</a> options add extra verbosity to the slow log.</p>

<p>The option is <code class="highlighter-rouge">log_slow_verbosity</code> and it has several options. Just keep in mind that <code class="highlighter-rouge">full</code> does not include <code class="highlighter-rouge">profiling</code> neither <code class="highlighter-rouge">profiling_use_getrusage</code>. I assume that you don’t need to enable profiling just the first time you run a query review. It will interesting to enable the full query collection if using <a href="https://www.percona.com/doc/percona-playback/index.html">Percona Playback</a>.</p>

<h2 id="pt-query-digest-is-your-friend"><a href="https://www.percona.com/doc/percona-toolkit/2.2/pt-query-digest.html#cmdoption-pt-query-digest--review">pt-query-digest</a> is your friend</h2>

<p><code class="highlighter-rouge">pt-query-digest</code> can be used with an impressive set of options. Before you use it, I encourage the reader to do a quick read over its documentation.</p>

<p>For example, you can gather not only the report but also the explains of the queries safely (that is, if a query has a subquery, it won’t execute the query on the master).</p>

<div class="highlighter-rouge"><pre class="highlight"><code>pt-query-digest --type=slowlog --report-all --explain h=172.17.0.2 --user=root --password=mysql /var/lib/docker/volumes/ceda51de62dac317fcafe9dd9e8f9b6f1dc5d70874466b3faf7cdfbcbbc91154/_data/cb740be0743c-slow.log &gt; /tmp/report.txt
</code></pre>
</div>

<h2 id="examining-the-query-results">Examining the query results</h2>

<ul>
  <li>Rows examined vs. rows returned</li>
  <li>The order of the result</li>
  <li>Does the application uses the full set of rows? Limit the number of rows as much as possible</li>
</ul>

<h2 id="other-complementary-tools">Other complementary tools</h2>

<h3 id="anemometer"><a href="https://github.com/box/Anemometer">Anemometer</a></h3>

<p>If you have a large fleet of MySQL servers and you usually do query analysis, the <em>next tool</em> you want to look is <a href="https://github.com/3manuek/Anemometer">Anemometer</a>.Originally, this project has been made by Box, however if you want to test the vagrant machine, I suggest to use the fork linked above. The project looks like stable and they are not merging new pull requests. It just works.</p>

<p>The idea was to have available in a single glance the slow logs, which can become very handy when scaling complex boxes. Also it improves proactive monitoring and partial trending.</p>

<h3 id="binlogeventstats"><a href="https://github.com/pythian/binlogEventStats">binlogEventStats</a></h3>

<p>The idea is to do a <em>top style</em> metrics of the  streamed transactions from the replication flow in a more detailed way, so you can see the writes from a master (ideally to trace/debug slave lags). This is not entirely related with Query Reviews generally, however it could be a detection tool when some unexpected floods happen.</p>

<blockquote>
  <p>Note: Is still in development.</p>
</blockquote>

<h2 id="the-main-parts-of-the-pt-query-digest">The main parts of the <code class="highlighter-rouge">pt-query-digest</code></h2>

<ul>
  <li>Overall stats (useful for general comparisons)</li>
  <li>Profile: Query by ranking in terms of execution time.</li>
  <li>Queries: Each query with execution details.</li>
</ul>

<h3 id="where-do-i-start-analyzing">Where do I start analyzing?</h3>

<p>The general rule of the thumb is start by the heaviest down to the others. I would
say that it depends on how much time you want to waste and the complexity of the queries.</p>

<p>My recommendation is to do the queries that consume more than 40-50% of accumulated execution time on BI servers
and 50-70% when it is an OLTP workload.</p>

<p>Once you do a first query review, the subsequent analysis will not be very useful if no
changes are applied on the queries.</p>

<h3 id="get-the-table-details">Get the table details</h3>

<p>How to execute the SHOWS in the <code class="highlighter-rouge">pt-query-digest</code>:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>egrep <span class="s2">"SHOW.[TABLE|CREATE].*"</span> /tmp/report.txt | sed <span class="s1">'s/^#\s*//'</span> | sed <span class="s1">'s/\\/\\\\/g'</span> | sort | uniq | sed <span class="s2">"s/'/</span><span class="se">\\\'</span><span class="s2">/g"</span> | xargs -i mysql --user<span class="o">=</span>mysql --password<span class="o">=</span>SHADOW -e <span class="o">{}</span> &gt; /tmp/SHOW.txt
</code></pre>
</div>

<p>As a rule, the rewritten query should return the same amount of records and order, unless
your recommendation specifies that the current result set size or order are not
convenient. i.e. very large result sets with a lot of discarded rows from the application,
a query that is returning an incorrect order, etc.</p>

<h2 id="comparing-the-before-and-after">Comparing the before and after</h2>

<p>Finally, once changes have been made (any change)</p>

<ul>
  <li>Same interval of time and day use ( <code class="highlighter-rouge">--since</code> and <code class="highlighter-rouge">--until</code> options ).</li>
  <li><code class="highlighter-rouge">--review</code> option will help you to do incremental analysis.</li>
  <li>TPS before and after.</li>
  <li>Overall Execution time make easier the job of comparing the effectiveness of the changes.</li>
  <li>Use always the same <code class="highlighter-rouge">long_query_time</code> on both.</li>
</ul>

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/fts-innodb" title="MySQL 5.7 InnoDB's Full Text Search overview.">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/keeppersistentconnections" title="Keeping persistent connections in Postgres.">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'jekyllbootstrap'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>22 June 2016</span></div>

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/tags.html#MySQL-ref">MySQL <span>3</span></a></li>
     
    	<li><a href="/tags.html#SQL-ref">SQL <span>1</span></a></li>
     
    	<li><a href="/tags.html#tuning-ref">tuning <span>1</span></a></li>
    
  



    </ul>
    
  </div>
</div>


      </div>

      <footer>
        <p>&copy; Emanuel Calvo 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    



  </body>
</html>

