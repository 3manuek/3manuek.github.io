<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Clickhouse sampling on MergeTree engine. | tr3sma</title><meta name=description content><meta property="og:title" content="Clickhouse sampling on MergeTree engine."><meta property="og:description" content="Why sampling is important and what you need to be aware of? When dealing with very large amount of data, you probably want to run your queries only for a smaller dataset in your current tables. Specially if your dataset is not fitting in RAM.
MergeTree is the first and more advanced engine on Clickhouse that you want to try. It supports indexing by Primary Key and it is mandatory to have a column of Date type (used for automatic partitioning)."><meta property="og:type" content="article"><meta property="og:url" content="https://tr3s.ma/blog/2019-06/clickhouse-sampling-data/"><meta property="og:image" content="https://tr3s.ma/blog/assets/thumbnail_db.png"><meta property="og:image" content="https://tr3s.ma/blog/assets/tachyons-logo-script-feature.png"><meta property="article:published_time" content="2017-07-01T00:00:00+00:00"><meta property="article:modified_time" content="2017-07-01T00:00:00+00:00"><meta itemprop=name content="Clickhouse sampling on MergeTree engine."><meta itemprop=description content="Why sampling is important and what you need to be aware of? When dealing with very large amount of data, you probably want to run your queries only for a smaller dataset in your current tables. Specially if your dataset is not fitting in RAM.
MergeTree is the first and more advanced engine on Clickhouse that you want to try. It supports indexing by Primary Key and it is mandatory to have a column of Date type (used for automatic partitioning)."><meta itemprop=datePublished content="2017-07-01T00:00:00+00:00"><meta itemprop=dateModified content="2017-07-01T00:00:00+00:00"><meta itemprop=wordCount content="1237"><meta itemprop=image content="https://tr3s.ma/blog/assets/thumbnail_db.png"><meta itemprop=image content="https://tr3s.ma/blog/assets/tachyons-logo-script-feature.png"><meta itemprop=keywords content="hugo-site,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tr3s.ma/blog/assets/thumbnail_db.png"><meta name=twitter:title content="Clickhouse sampling on MergeTree engine."><meta name=twitter:description content="Why sampling is important and what you need to be aware of? When dealing with very large amount of data, you probably want to run your queries only for a smaller dataset in your current tables. Specially if your dataset is not fitting in RAM.
MergeTree is the first and more advanced engine on Clickhouse that you want to try. It supports indexing by Primary Key and it is mandatory to have a column of Date type (used for automatic partitioning)."><meta name=twitter:site content="@3manuek"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','G-GY0KSNNSTL','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><!--[if IE]><script src=//html5shiv.googlecode.com/svn/trunk/html5.js></script><![endif]--><link rel="shortcut icon" href="/img/favicon.ico?v=0" type=image/x-icon><link rel=icon href="/img/favicon.ico?v=0" type=image/x-icon><link rel=stylesheet href=https://tr3s.ma/style.main.min.af051a891b2af29b5e832059f2d65564f8acece3291dcaca54df6ef06e3e084e.css integrity="sha256-rwUaiRsq8ptegyBZ8tZVZPis7OMpHcrKVN9u8G4+CE4=" media=screen></head><body><div class="grid-container single"><header class="site-header pa4 bb b--transparent" role=banner><nav class="site-nav db dt-l w-100" role=nav><a class="site-brand db dtc-l v-mid link no-underline w-100 w-33-l tc tl-l" href=https://tr3s.ma title=Home><img src=/img/firma.png class="dib db-l h2 w-auto" alt=tr3sma></a><div class="site-links db dtc-l v-mid w-100 w-47-l tc tr-l mt3 mt0-l"><a class="link f6 f5-l dib pv1 ph2" href=/ title="Home Page">Home</a>
<a class="link f6 f5-l dib pv1 ph2" href=/about/ title="About tr3sma">About</a>
<a class="link f6 f5-l dib pv1 ph2" href=/blog/ title=Blog>Blog</a>
<a class="link f6 f5-l dib pv1 ph2" href=/contact/ title="Contact Form">Contact</a></div></nav></header><main class="page-main pa4" role=main><section class="page-content mw7 center"><article class="post-content pa0 ph4-l"><header class=post-header><h1 class="f2 f1-m f-subheadline-l fw5-ns mv4 lh-solid tracked-tight">Clickhouse sampling on MergeTree engine.</h1><h2 class="f7 fw7 measure mv0 ttu tracked">How MergeTree works using sampling feature</h2><p class="f6 measure lh-copy mv1">By 3manuek in <a href=https://tr3s.ma/categories/theme-features>Theme Features</a></p><p class="f7 db mv0 ttu">July 1, 2017</p></header><section class="post-body pt5 pb4"><h2 id=why-sampling-is-important-and-what-you-need-to-be-aware-of>Why sampling is important and what you need to be aware of?</h2><p>When dealing with very large amount of data, you probably want to run your
queries only for a smaller dataset in your current tables. Specially if your dataset
is not fitting in RAM.</p><p><code>MergeTree</code> is the first and more advanced engine on Clickhouse that you want to try.
It supports indexing by Primary Key and it is mandatory to have a column of <code>Date</code>
type (used for automatic partitioning).</p><p>Is the only engine that supports sampling, and only <em>if the sampling expression was defined
at table creation</em>. So, the rul of the thumb is that <strong>if the dataset does not fit in RAM you will prefer to
create the table with sampling support</strong>. Otherwise, <strong>there is no performance gain by using sampling
on relatively small tables that fit in RAM</strong>.</p><p>Sampling expression uses a hash function over a chosen column in order to generate pseudo randomly
data on each of the selected columns defined in the primary key. Then you can enable this feature by accesing
the data using the SAMPLE clause in the query.</p><p>Values of aggregate functions are not corrected automatically, so to get an approximate result,
the value ‘count()’ is manually multiplied by the factor of the sample. For instance, a sample
of 0.1 (10%) will need to be multiplied by 10, 0.2 will need to be multiplied by 5.</p><p>Suppose we have the 96MM rows in a distributed table, split in 2 shards:</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#007020;font-weight:700>SELECT</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>)
<span style=color:#007020;font-weight:700>FROM</span> database_report.stats_table_distributed

<span>┌</span><span>─</span><span>─</span><span style=color:#007020;font-weight:700>count</span>()<span>─</span><span>┐</span>
<span>│</span> <span style=color:#40a070>96414151</span> <span>│</span>
<span>└</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┘</span>
<span style=color:#40a070>1</span> <span style=color:#007020;font-weight:700>rows</span> <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020;font-weight:700>set</span>. Elapsed: <span style=color:#40a070>0</span>.<span style=color:#40a070>026</span> sec. Processed <span style=color:#40a070>96</span>.<span style=color:#40a070>41</span> million <span style=color:#007020;font-weight:700>rows</span>, <span style=color:#40a070>192</span>.<span style=color:#40a070>83</span> MB (<span style=color:#40a070>3</span>.<span style=color:#40a070>68</span> billion <span style=color:#007020;font-weight:700>rows</span><span style=color:#666>/</span>s., <span style=color:#40a070>7</span>.<span style=color:#40a070>36</span> GB<span style=color:#666>/</span>s.)
</code></pre></td></tr></table></div></div><p>If you use <code>SAMPLE > 100</code>, you&rsquo;ll probably get some dirty results, specially if you execute over
a distributed umbrella. In the bellow example is possible to see that the SAMPLE is over each
local table and aggregated later locally (there are 2 shards):</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#007020;font-weight:700>SELECT</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>)
<span style=color:#007020;font-weight:700>FROM</span> database_report.stats_table_local
SAMPLE <span style=color:#40a070>1000</span>
<span>┌</span><span>─</span><span style=color:#007020;font-weight:700>count</span>()<span>─</span><span>┐</span>
<span>│</span>    <span style=color:#40a070>1015</span> <span>│</span>
<span>└</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┘</span>
<span style=color:#40a070>1</span> <span style=color:#007020;font-weight:700>rows</span> <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020;font-weight:700>set</span>. Elapsed: <span style=color:#40a070>1</span>.<span style=color:#40a070>296</span> sec. Processed <span style=color:#40a070>48</span>.<span style=color:#40a070>21</span> million <span style=color:#007020;font-weight:700>rows</span>, <span style=color:#40a070>2</span>.<span style=color:#40a070>07</span> GB (<span style=color:#40a070>37</span>.<span style=color:#40a070>18</span> million <span style=color:#007020;font-weight:700>rows</span><span style=color:#666>/</span>s., <span style=color:#40a070>1</span>.<span style=color:#40a070>60</span> GB<span style=color:#666>/</span>s.)


<span style=color:#007020;font-weight:700>SELECT</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>)
<span style=color:#007020;font-weight:700>FROM</span> database_report.stats_table_distributed
SAMPLE <span style=color:#40a070>1000</span>
<span>┌</span><span>─</span><span style=color:#007020;font-weight:700>count</span>()<span>─</span><span>┐</span>
<span>│</span>    <span style=color:#40a070>2032</span> <span>│</span>
<span>└</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┘</span>
<span style=color:#40a070>1</span> <span style=color:#007020;font-weight:700>rows</span> <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020;font-weight:700>set</span>. Elapsed: <span style=color:#40a070>1</span>.<span style=color:#40a070>256</span> sec. Processed <span style=color:#40a070>96</span>.<span style=color:#40a070>41</span> million <span style=color:#007020;font-weight:700>rows</span>, <span style=color:#40a070>4</span>.<span style=color:#40a070>15</span> GB (<span style=color:#40a070>76</span>.<span style=color:#40a070>75</span> million <span style=color:#007020;font-weight:700>rows</span><span style=color:#666>/</span>s., <span style=color:#40a070>3</span>.<span style=color:#40a070>30</span> GB<span style=color:#666>/</span>s.)
</code></pre></td></tr></table></div></div><p>Instead, by using the relative coefficient format, the aggregations are more accurate/consistent in terms of total rows
gathered, although you&rsquo;ll need to fix the estimation depending on the coefficient:</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>
<span style=color:#007020;font-weight:700>SELECT</span> 
    <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#007020;font-weight:700>AS</span> count_over_sample,   <span style=color:#60a0b0;font-style:italic>-- Without fixing, we have x10 less rows
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#666>*</span> <span style=color:#40a070>10</span> <span style=color:#007020;font-weight:700>AS</span> count_estimated <span style=color:#60a0b0;font-style:italic>-- By 10 as we are sampling 10% of the table
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>FROM</span> database_report.stats_table_distributed
SAMPLE <span style=color:#40a070>1</span> <span style=color:#666>/</span> <span style=color:#40a070>10</span>

<span>┌</span><span>─</span>count_over_sample<span>─</span><span>┬</span><span>─</span>count_estimated<span>─</span><span>┐</span>
<span>│</span>           <span style=color:#40a070>9641965</span> <span>│</span>        <span style=color:#40a070>96419650</span> <span>│</span>
<span>└</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┴</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┘</span>
<span style=color:#40a070>1</span> <span style=color:#007020;font-weight:700>rows</span> <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020;font-weight:700>set</span>. Elapsed: <span style=color:#40a070>1</span>.<span style=color:#40a070>442</span> sec. Processed <span style=color:#40a070>96</span>.<span style=color:#40a070>41</span> million <span style=color:#007020;font-weight:700>rows</span>, <span style=color:#40a070>4</span>.<span style=color:#40a070>15</span> GB (<span style=color:#40a070>66</span>.<span style=color:#40a070>84</span> million <span style=color:#007020;font-weight:700>rows</span><span style=color:#666>/</span>s., <span style=color:#40a070>2</span>.<span style=color:#40a070>87</span> GB<span style=color:#666>/</span>s.)
</code></pre></td></tr></table></div></div><p>The path of the execution on sampling can be seen in the following animation:</p><h2 id=hasing-functions-for-sampling-int-and-strings>Hasing functions for sampling Int and Strings</h2><p>You have several hashing functions (intHash32 for integers and cityHash64 for strings) although
you may stick with those non-cryptographic in order to don&rsquo;t affect the performance.</p><p>Example without sampling support: <code>MergeTree(EventDate, (CounterID, EventDate), 8192)</code></p><p>Example with sampling support: <code>MergeTree(EventDate, intHash32(UserID), (CounterID, EventDate, intHash32(UserID)), 8192)</code></p><p>The examples on this article use cityHash64, as the id is a <code>String</code>. Also the distribution
is random, in order to warrante the parallelization of the queries:</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#007020;font-weight:700>CREATE</span> <span style=color:#007020;font-weight:700>TABLE</span> database_report.stats_table_local ( ...)
ENGINE <span style=color:#666>=</span> MergeTree(normdate, cityHash64(id), (created_at, id, cityHash64(id)), <span style=color:#40a070>8192</span>);   

<span style=color:#007020;font-weight:700>CREATE</span> <span style=color:#007020;font-weight:700>TABLE</span> database_report.stats_table_distributed <span style=color:#007020;font-weight:700>AS</span> database_report.stats_table_local 
ENGINE <span style=color:#666>=</span> Distributed(database_report, database_report, stats_table_local, rand());
</code></pre></td></tr></table></div></div><h2 id=handling-accuracy-properly>Handling accuracy properly</h2><p>Here is another example when gathering aggregations over sampling. The bellow statement
is a non-sampled query:</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#007020;font-weight:700>SELECT</span> <span style=color:#007020;font-weight:700>DISTINCT</span> 
    address,
    <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>)
<span style=color:#007020;font-weight:700>FROM</span> database_report.stats_table_distributed
<span style=color:#007020;font-weight:700>GROUP</span> <span style=color:#007020;font-weight:700>BY</span> address
<span style=color:#007020;font-weight:700>HAVING</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#666>&gt;</span> <span style=color:#40a070>500000</span>
<span style=color:#007020;font-weight:700>ORDER</span> <span style=color:#007020;font-weight:700>BY</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#007020;font-weight:700>DESC</span>

<span>┌</span><span>─</span>address<span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┬</span><span>─</span><span style=color:#007020;font-weight:700>count</span>()<span>─</span><span>┐</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>222</span>      <span>│</span> <span style=color:#40a070>7431672</span> <span>│</span>
<span>│</span> <span style=color:#40a070>1</span>.<span style=color:#40a070>3</span>.<span style=color:#40a070>2</span>.<span style=color:#40a070>1</span>         <span>│</span> <span style=color:#40a070>4727411</span> <span>│</span>
<span>│</span> <span style=color:#40a070>104</span>.<span style=color:#40a070>123</span>.<span style=color:#40a070>123</span>.<span style=color:#40a070>198</span> <span>│</span> <span style=color:#40a070>2377910</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>20</span>.<span style=color:#40a070>110</span>     <span>│</span> <span style=color:#40a070>2366481</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>5</span>.<span style=color:#40a070>6</span>        <span>│</span> <span style=color:#40a070>1852113</span> <span>│</span>
<span>│</span> <span style=color:#40a070>12</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>2</span>.<span style=color:#40a070>4</span>        <span>│</span> <span style=color:#40a070>1413009</span> <span>│</span>
<span>│</span> <span style=color:#40a070>54</span>.<span style=color:#40a070>84</span>.<span style=color:#40a070>210</span>.<span style=color:#40a070>50</span>    <span>│</span> <span style=color:#40a070>1141153</span> <span>│</span>
<span>│</span> <span style=color:#40a070>63</span>.<span style=color:#40a070>138</span>.<span style=color:#40a070>62</span>.<span style=color:#40a070>1</span>     <span>│</span>  <span style=color:#40a070>950598</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>11</span>       <span>│</span>  <span style=color:#40a070>738150</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>15</span>       <span>│</span>  <span style=color:#40a070>709582</span> <span>│</span>
<span>│</span> <span style=color:#40a070>90</span>.<span style=color:#40a070>110</span>.<span style=color:#40a070>131</span>.<span style=color:#40a070>100</span>  <span>│</span>  <span style=color:#40a070>601535</span> <span>│</span>
<span>│</span> <span style=color:#40a070>65</span>.<span style=color:#40a070>30</span>.<span style=color:#40a070>67</span>.<span style=color:#40a070>32</span>     <span>│</span>  <span style=color:#40a070>584043</span> <span>│</span>
<span>└</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┴</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┘</span>
<span style=color:#40a070>12</span> <span style=color:#007020;font-weight:700>rows</span> <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020;font-weight:700>set</span>. Elapsed: <span style=color:#40a070>1</span>.<span style=color:#40a070>668</span> sec. Processed <span style=color:#40a070>96</span>.<span style=color:#40a070>41</span> million <span style=color:#007020;font-weight:700>rows</span>, <span style=color:#40a070>2</span>.<span style=color:#40a070>04</span> GB (<span style=color:#40a070>57</span>.<span style=color:#40a070>79</span> million <span style=color:#007020;font-weight:700>rows</span><span style=color:#666>/</span>s., <span style=color:#40a070>1</span>.<span style=color:#40a070>23</span> GB<span style=color:#666>/</span>s.)
</code></pre></td></tr></table></div></div><p>But, if we sample without fixing the aggregations:</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#007020;font-weight:700>SELECT</span> <span style=color:#007020;font-weight:700>DISTINCT</span> 
    address,
    <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>)
<span style=color:#007020;font-weight:700>FROM</span> database_report.stats_table_distributed
SAMPLE <span style=color:#40a070>1</span> <span style=color:#666>/</span> <span style=color:#40a070>10</span>
<span style=color:#007020;font-weight:700>GROUP</span> <span style=color:#007020;font-weight:700>BY</span> address
<span style=color:#007020;font-weight:700>HAVING</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#666>&gt;</span> <span style=color:#40a070>500000</span>
<span style=color:#007020;font-weight:700>ORDER</span> <span style=color:#007020;font-weight:700>BY</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#007020;font-weight:700>DESC</span>

<span>┌</span><span>─</span>address<span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┬</span><span>─</span><span style=color:#007020;font-weight:700>count</span>()<span>─</span><span>┐</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>222</span>     <span>│</span>  <span style=color:#40a070>744235</span> <span>│</span>
<span>└</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┴</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┘</span>
<span style=color:#40a070>1</span> <span style=color:#007020;font-weight:700>rows</span> <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020;font-weight:700>set</span>. Elapsed: <span style=color:#40a070>2</span>.<span style=color:#40a070>127</span> sec. Processed <span style=color:#40a070>96</span>.<span style=color:#40a070>41</span> million <span style=color:#007020;font-weight:700>rows</span>, <span style=color:#40a070>6</span>.<span style=color:#40a070>00</span> GB (<span style=color:#40a070>45</span>.<span style=color:#40a070>32</span> million <span style=color:#007020;font-weight:700>rows</span><span style=color:#666>/</span>s., <span style=color:#40a070>2</span>.<span style=color:#40a070>82</span> GB<span style=color:#666>/</span>s.)
</code></pre></td></tr></table></div></div><p>You can add some fixing around and increase the sample in order to get more accurate results:</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#007020;font-weight:700>SELECT</span> <span style=color:#007020;font-weight:700>DISTINCT</span> 
    address,
    <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#666>*</span> <span style=color:#40a070>10</span>
<span style=color:#007020;font-weight:700>FROM</span> database_report.stats_table_distributed
SAMPLE <span style=color:#40a070>1</span> <span style=color:#666>/</span> <span style=color:#40a070>10</span>
<span style=color:#007020;font-weight:700>GROUP</span> <span style=color:#007020;font-weight:700>BY</span> address
<span style=color:#007020;font-weight:700>HAVING</span> (<span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#666>*</span> <span style=color:#40a070>10</span>) <span style=color:#666>&gt;</span> <span style=color:#40a070>500000</span>
<span style=color:#007020;font-weight:700>ORDER</span> <span style=color:#007020;font-weight:700>BY</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#007020;font-weight:700>DESC</span>

<span>┌</span><span>─</span>address<span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┬</span><span>─</span>multiply(<span style=color:#007020;font-weight:700>count</span>(), <span style=color:#40a070>10</span>)<span>─</span><span>┐</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>222</span>      <span>│</span>               <span style=color:#40a070>7442350</span> <span>│</span>
<span>│</span> <span style=color:#40a070>1</span>.<span style=color:#40a070>3</span>.<span style=color:#40a070>2</span>.<span style=color:#40a070>1</span>         <span>│</span>               <span style=color:#40a070>4725650</span> <span>│</span>
<span>│</span> <span style=color:#40a070>104</span>.<span style=color:#40a070>123</span>.<span style=color:#40a070>123</span>.<span style=color:#40a070>198</span> <span>│</span>               <span style=color:#40a070>2381920</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>20</span>.<span style=color:#40a070>110</span>     <span>│</span>               <span style=color:#40a070>2363170</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>5</span>.<span style=color:#40a070>6</span>        <span>│</span>               <span style=color:#40a070>1856500</span> <span>│</span>
<span>│</span> <span style=color:#40a070>12</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>2</span>.<span style=color:#40a070>4</span>        <span>│</span>               <span style=color:#40a070>1413860</span> <span>│</span>
<span>│</span> <span style=color:#40a070>54</span>.<span style=color:#40a070>84</span>.<span style=color:#40a070>210</span>.<span style=color:#40a070>50</span>    <span>│</span>               <span style=color:#40a070>1141190</span> <span>│</span>
<span>│</span> <span style=color:#40a070>63</span>.<span style=color:#40a070>138</span>.<span style=color:#40a070>62</span>.<span style=color:#40a070>1</span>     <span>│</span>                <span style=color:#40a070>954630</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>11</span>       <span>│</span>                <span style=color:#40a070>739530</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>15</span>       <span>│</span>                <span style=color:#40a070>712970</span> <span>│</span>
<span>│</span> <span style=color:#40a070>90</span>.<span style=color:#40a070>110</span>.<span style=color:#40a070>131</span>.<span style=color:#40a070>100</span>  <span>│</span>                <span style=color:#40a070>604510</span> <span>│</span>
<span>│</span> <span style=color:#40a070>65</span>.<span style=color:#40a070>30</span>.<span style=color:#40a070>67</span>.<span style=color:#40a070>32</span>     <span>│</span>                <span style=color:#40a070>583320</span> <span>│</span>
<span>└</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┴</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┘</span>
<span style=color:#40a070>12</span> <span style=color:#007020;font-weight:700>rows</span> <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020;font-weight:700>set</span>. Elapsed: <span style=color:#40a070>2</span>.<span style=color:#40a070>134</span> sec. Processed <span style=color:#40a070>96</span>.<span style=color:#40a070>41</span> million <span style=color:#007020;font-weight:700>rows</span>, <span style=color:#40a070>6</span>.<span style=color:#40a070>00</span> GB (<span style=color:#40a070>45</span>.<span style=color:#40a070>17</span> million <span style=color:#007020;font-weight:700>rows</span><span style=color:#666>/</span>s., <span style=color:#40a070>2</span>.<span style=color:#40a070>81</span> GB<span style=color:#666>/</span>s.)

<span style=color:#007020;font-weight:700>SELECT</span> <span style=color:#007020;font-weight:700>DISTINCT</span> 
    address,
    <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#666>*</span> <span style=color:#40a070>5</span>
<span style=color:#007020;font-weight:700>FROM</span> database_report.stats_table_distributed
SAMPLE <span style=color:#40a070>2</span> <span style=color:#666>/</span> <span style=color:#40a070>10</span>
<span style=color:#007020;font-weight:700>GROUP</span> <span style=color:#007020;font-weight:700>BY</span> address
<span style=color:#007020;font-weight:700>HAVING</span> (<span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#666>*</span> <span style=color:#40a070>5</span>) <span style=color:#666>&gt;</span> <span style=color:#40a070>500000</span>
<span style=color:#007020;font-weight:700>ORDER</span> <span style=color:#007020;font-weight:700>BY</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#007020;font-weight:700>DESC</span>

<span>┌</span><span>─</span>address<span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┬</span><span>─</span>multiply(<span style=color:#007020;font-weight:700>count</span>(), <span style=color:#40a070>5</span>)<span>─</span><span>┐</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>222</span>      <span>│</span>              <span style=color:#40a070>7430545</span> <span>│</span>
<span>│</span> <span style=color:#40a070>1</span>.<span style=color:#40a070>3</span>.<span style=color:#40a070>2</span>.<span style=color:#40a070>1</span>         <span>│</span>              <span style=color:#40a070>4730535</span> <span>│</span>
<span>│</span> <span style=color:#40a070>104</span>.<span style=color:#40a070>123</span>.<span style=color:#40a070>123</span>.<span style=color:#40a070>198</span> <span>│</span>              <span style=color:#40a070>2378665</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>20</span>.<span style=color:#40a070>110</span>     <span>│</span>              <span style=color:#40a070>2364765</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>5</span>.<span style=color:#40a070>6</span>        <span>│</span>              <span style=color:#40a070>1854600</span> <span>│</span>
<span>│</span> <span style=color:#40a070>12</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>2</span>.<span style=color:#40a070>4</span>        <span>│</span>              <span style=color:#40a070>1412980</span> <span>│</span>
<span>│</span> <span style=color:#40a070>54</span>.<span style=color:#40a070>84</span>.<span style=color:#40a070>210</span>.<span style=color:#40a070>50</span>    <span>│</span>              <span style=color:#40a070>1142130</span> <span>│</span>
<span>│</span> <span style=color:#40a070>63</span>.<span style=color:#40a070>138</span>.<span style=color:#40a070>62</span>.<span style=color:#40a070>1</span>     <span>│</span>               <span style=color:#40a070>952105</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>11</span>       <span>│</span>               <span style=color:#40a070>740335</span> <span>│</span>
<span>│</span> <span style=color:#40a070>10</span>.<span style=color:#40a070>0</span>.<span style=color:#40a070>1</span>.<span style=color:#40a070>15</span>       <span>│</span>               <span style=color:#40a070>709805</span> <span>│</span>
<span>│</span> <span style=color:#40a070>90</span>.<span style=color:#40a070>110</span>.<span style=color:#40a070>131</span>.<span style=color:#40a070>100</span>  <span>│</span>               <span style=color:#40a070>603960</span> <span>│</span>
<span>│</span> <span style=color:#40a070>65</span>.<span style=color:#40a070>30</span>.<span style=color:#40a070>67</span>.<span style=color:#40a070>32</span>     <span>│</span>               <span style=color:#40a070>582545</span> <span>│</span>
<span>└</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┴</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>─</span><span>┘</span>
<span style=color:#40a070>12</span> <span style=color:#007020;font-weight:700>rows</span> <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020;font-weight:700>set</span>. Elapsed: <span style=color:#40a070>2</span>.<span style=color:#40a070>344</span> sec. Processed <span style=color:#40a070>96</span>.<span style=color:#40a070>41</span> million <span style=color:#007020;font-weight:700>rows</span>, <span style=color:#40a070>6</span>.<span style=color:#40a070>00</span> GB (<span style=color:#40a070>41</span>.<span style=color:#40a070>13</span> million <span style=color:#007020;font-weight:700>rows</span><span style=color:#666>/</span>s., <span style=color:#40a070>2</span>.<span style=color:#40a070>56</span> GB<span style=color:#666>/</span>s.)
</code></pre></td></tr></table></div></div><h2 id=performance-heads-up>Performance heads up</h2><p>If the dataset is smaller than the amount of RAM, sampling won&rsquo;t help in terms of performance.
The bellow is an example of a bigger result set using no-sampling and sampling.</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#007020;font-weight:700>SELECT</span> 
    some_type,
    <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>)
<span style=color:#007020;font-weight:700>FROM</span> database_report.stats_table_distributed
<span style=color:#007020;font-weight:700>GROUP</span> <span style=color:#007020;font-weight:700>BY</span> some_type
<span style=color:#007020;font-weight:700>HAVING</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#666>&gt;</span> <span style=color:#40a070>1000000</span>
<span style=color:#007020;font-weight:700>ORDER</span> <span style=color:#007020;font-weight:700>BY</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#007020;font-weight:700>DESC</span>
[...]
<span style=color:#40a070>15</span> <span style=color:#007020;font-weight:700>rows</span> <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020;font-weight:700>set</span>. Elapsed: <span style=color:#40a070>1</span>.<span style=color:#40a070>534</span> sec. Processed <span style=color:#40a070>96</span>.<span style=color:#40a070>41</span> million <span style=color:#007020;font-weight:700>rows</span>, <span style=color:#40a070>1</span>.<span style=color:#40a070>95</span> GB (<span style=color:#40a070>62</span>.<span style=color:#40a070>84</span> million <span style=color:#007020;font-weight:700>rows</span><span style=color:#666>/</span>s., <span style=color:#40a070>1</span>.<span style=color:#40a070>27</span> GB<span style=color:#666>/</span>s.)

<span style=color:#007020;font-weight:700>SELECT</span> 
    some_type,
    <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#666>*</span> <span style=color:#40a070>10</span>
<span style=color:#007020;font-weight:700>FROM</span> database_report.stats_table_distributed
SAMPLE <span style=color:#40a070>1</span> <span style=color:#666>/</span> <span style=color:#40a070>10</span>
<span style=color:#007020;font-weight:700>GROUP</span> <span style=color:#007020;font-weight:700>BY</span> some_type
<span style=color:#007020;font-weight:700>HAVING</span> (<span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#666>*</span> <span style=color:#40a070>10</span>) <span style=color:#666>&gt;</span> <span style=color:#40a070>1000000</span>
<span style=color:#007020;font-weight:700>ORDER</span> <span style=color:#007020;font-weight:700>BY</span> <span style=color:#007020;font-weight:700>count</span>(<span style=color:#666>*</span>) <span style=color:#007020;font-weight:700>DESC</span>
[...]
<span style=color:#40a070>15</span> <span style=color:#007020;font-weight:700>rows</span> <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020;font-weight:700>set</span>. Elapsed: <span style=color:#40a070>2</span>.<span style=color:#40a070>123</span> sec. Processed <span style=color:#40a070>96</span>.<span style=color:#40a070>41</span> million <span style=color:#007020;font-weight:700>rows</span>, <span style=color:#40a070>5</span>.<span style=color:#40a070>90</span> GB (<span style=color:#40a070>45</span>.<span style=color:#40a070>41</span> million <span style=color:#007020;font-weight:700>rows</span><span style=color:#666>/</span>s., <span style=color:#40a070>2</span>.<span style=color:#40a070>78</span> GB<span style=color:#666>/</span>s.)
</code></pre></td></tr></table></div></div><details closed class="f6 fw7 input-reset"><dl class="f6 lh-copy"><dt class=fw7>Posted on:</dt><dd class="fw5 ml0">July 1, 2017</dd></dl><dl class="f6 lh-copy"><dt class=fw7>Length:</dt><dd class="fw5 ml0">6 minute read, 1237 words</dd></dl><dl class="f6 lh-copy"><dt class=fw7>Categories:</dt><dd class="fw5 ml0"><a href=https://tr3s.ma/categories/theme-features>Theme Features</a></dd></dl><dl class="f6 lh-copy"><dt class=fw7>Series:</dt><dd class="fw5 ml0"><a href=https://tr3s.ma/series/getting-started>Getting Started</a></dd></dl><dl class="f6 lh-copy"><dt class=fw7>Tags:</dt><dd class="fw5 ml0"><a href=https://tr3s.ma/tags/hugo-site>hugo-site</a></dd></dl><dl class="f6 lh-copy"><dt class=fw7>See Also:</dt><dd class="fw5 ml0"><a href=/blog/2020-01/openlabs/>Open Labs</a></dd><dd class="fw5 ml0"><a href=/blog/2019-07/terraformwithpostgres/>What are the perks of using Postgres as a Terraform backend?</a></dd><dd class="fw5 ml0"><a href=/blog/2019-07/ansiblekubernetes/>Ansible and Kubernetes</a></dd></dl></details></section><footer class=post-footer><div class="post-pagination dt w-100 mt4 mb2"><a class="prev dtc pr2 tl v-top fw6" href=https://tr3s.ma/blog/2017-03/import-data-to-ch-from-rs/>&larr; Import data from Redshift into Clickhouse in a single command.</a>
<a class="next dtc pl2 tr v-top fw6" href=https://tr3s.ma/blog/2019-06/ilb-internal-gcp/>Google Cloud TCP Internal Load Balancing with HTTP Health Checks in Terraform for stateful services &rarr;</a></div></footer></article></section></main><footer class="site-footer pa4 bt b--transparent" role=contentinfo><nav class="db dt-l w-100"><p class="site-copyright f7 db dtc-l v-mid w-100 w-33-l tc tl-l pv2 pv0-l mv0 lh-copy">&copy; 2022 tr3sma, Madrid, Spain<br></p><div class="site-links f6 db dtc-l v-mid w-100 w-67-l tc tr-l pv2 pv0-l mv0"><a class="dib pv1 ph2 link" href=/index.xml title="RSS Feed">RSS</a></div></nav></footer></div></body></html>